package com.dbs.cb.gapi.core.repository;

import com.dbs.cb.gapi.core.entity.GapiMappingTransformerEntity;
import com.dbs.cb.gapi.core.exception.TransformationException;
import com.dbs.cb.gapi.core.transformer.MappingConfig;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.stereotype.Component;

import java.util.HashMap;
import java.util.Map;

@Slf4j
@Component
@RequiredArgsConstructor
@ConditionalOnProperty(
    name = "transformer.mapping-source",
    havingValue = "database"
)
public class MappingConfigRepositoryDbImpl implements MappingConfigRepository {

    private final GapiMappingTransformerJpaRepository jpaRepository;
    private final ObjectMapper objectMapper;

    private final Map<String, MappingConfig> cache = new HashMap<>();

    @Override
    public MappingConfig getMappingConfig(String mappingId) {
        MappingConfig cached = cache.get(mappingId);
        if (cached != null) {
            return cached;
        }

        GapiMappingTransformerEntity entity = jpaRepository.findById(mappingId)
                .orElseThrow(() ->
                        new IllegalArgumentException("Mapping config not found for mappingId: " + mappingId));

        MappingConfig config = parseMappingJson(entity.getMappingJson(), mappingId);
        cache.put(mappingId, config);
        return config;
    }

    @Override
    public void loadAllMappingConfigs() {
        log.info("Loading all mapping configs from database (gapi_mapping_transformers)");
        long start = System.currentTimeMillis();

        jpaRepository.findByApprovalStatus("APPROVED").forEach(entity -> {
            MappingConfig config = parseMappingJson(entity.getMappingJson(), entity.getMappingId());
            cache.put(config.getMappingId(), config);
            log.info("Loaded mapping config from DB: {}", config.getMappingId());
        });

        log.info("CONFIG_MAPPING_DB_LATENCY {} ms", System.currentTimeMillis() - start);
    }

    private MappingConfig parseMappingJson(String json, String mappingId) {
        try {
            MappingConfig config = objectMapper.readValue(json, MappingConfig.class);
            if (config.getMappingId() == null) {
                // enforce mappingId if not present inside JSON
                config.setMappingId(mappingId);
            }
            return config;
        } catch (Exception e) {
            log.error("Failed to parse mappingJson for mappingId {}: {}", mappingId, e.getMessage(), e);
            throw new TransformationException("Failed to parse mapping JSON for mappingId: " + mappingId, e);
        }
    }
}







<dependency>
			<groupId>org.mariadb.jdbc</groupId>





			<artifactId>mariadb-java-client</artifactId>
			<scope>runtime</scope>
		</dependency>
spring:
  datasource:
    url: jdbc:h2:mem:transformerdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password:

  h2:
    console:
      enabled: true

management:
  endpoints:
    web:
      exposure:
        include: health,info,h2-console
  endpoint:
    h2-console:
      enabled: true



<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>



<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope>
</dependency>



CREATE TABLE IF NOT EXISTS gapi_mapping_transformers (
    mapping_id VARCHAR(255) PRIMARY KEY,
    mapping_json CLOB NOT NULL,
    mapping_json_staging CLOB,
    ticket_id VARCHAR(16),
    approval_status VARCHAR(16),
    created_by VARCHAR(64),
    modified_by VARCHAR(64),
    approved_by VARCHAR(64),
    modified_by_staging VARCHAR(64),
    created_time TIMESTAMP,
    modified_time TIMESTAMP,
    approved_time TIMESTAMP,
    modified_time_staging TIMESTAMP,
    updated_time TIMESTAMP
);


@Entity
@Table(name = "gapi_mapping_transformers")
@Data
public class GapiMappingTransformerEntity {

    @Id
    @Column(name = "mapping_id", length = 255)
    private String mappingId;    // Primary key (e.g., "account-status-mapping")

    @Lob
    @Column(name = "mapping_json", nullable = false)
    private String mappingJson;   // Main JSON

    @Lob
    @Column(name = "mapping_json_staging")
    private String mappingJsonStaging;   // Staging JSON

    @Column(name = "ticket_id", length = 16)
    private String ticketId;

    @Column(name = "approval_status", length = 16)
    private String approvalStatus; // PENDING / APPROVED / REJECTED

    @Column(name = "created_by", length = 64)
    private String createdBy;

    @Column(name = "modified_by", length = 64)
    private String modifiedBy;

    @Column(name = "approved_by", length = 64)
    private String approvedBy;

    @Column(name = "modified_by_staging", length = 64)
    private String modifiedByStaging;

    @Column(name = "created_time", updatable = false)
    private LocalDateTime createdTime;

    @Column(name = "modified_time")
    private LocalDateTime modifiedTime;

    @Column(name = "approved_time")
    private LocalDateTime approvedTime;

    @Column(name = "modified_time_staging")
    private LocalDateTime modifiedTimeStaging;

    @Column(name = "updated_time")
    private LocalDateTime updatedTime;
}
